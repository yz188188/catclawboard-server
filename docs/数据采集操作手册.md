# CatClawBoard 数据采集操作手册

## 一、环境信息

| 项目 | 路径 / 值 |
|------|-----------|
| 项目目录 | `C:\Users\mac\Desktop\Coiding\catclawboard-server` |
| Python | `C:\Program Files\Python311\python.exe` |
| iFinD 客户端 | `D:\THSDataInterface_Windows\SuperCommand.exe` |
| 数据库 | `mysql+pymysql://root:yz188188@34.123.208.235:3306/catclawboard` |

---

## 二、采集脚本说明

共 3 个采集脚本，**必须按顺序执行**：

| 顺序 | 脚本 | 功能 | 采集内容 |
|------|------|------|----------|
| 1 | `app.collectors.stat` | 赚钱效应统计 | 涨停板数量、连板数、一字板数、涨停封单额、涨停原因明细 |
| 2 | `app.collectors.thsdata` | 涨停反包数据 | 昨日涨停股中今日振幅>=10%且回撤<10%的股票（依赖 stat 的涨停数据） |
| 3 | `app.collectors.bidding` | 竞价数据 | 竞价涨停/跌停统计、昨日涨停股竞价爆量检测（依赖 stat 的涨停数据） |

> **注意**: thsdata 和 bidding 都依赖 stat 写入的昨日涨停数据，所以 **stat 必须最先运行**。

---

## 三、每日操作步骤

### 第 1 步：打开终端

打开 **PowerShell** 或 **命令提示符**，进入项目目录：

```powershell
cd C:\Users\mac\Desktop\Coiding\catclawboard-server
```

### 第 2 步：按顺序运行采集脚本

**采集当天数据**（默认取当前日期，自动回退到最近交易日）：

```powershell
python -m app.collectors.stat
python -m app.collectors.thsdata
python -m app.collectors.bidding
```

**采集指定日期数据**（格式 YYYY-MM-DD）：

```powershell
python -m app.collectors.stat 2026-02-13
python -m app.collectors.thsdata 2026-02-13
python -m app.collectors.bidding 2026-02-13
```

### 第 3 步：确认结果

每个脚本运行成功后会输出采集结果，例如：

```
THS 登录成功
stat 采集完成: {'date': '20260213', 'ztje': 152.35, 'maxlb': 5, 'zts': 48, 'lbs': 12, 'yzb': 8, 'yzbfd': 23.45}
```

```
THS 登录成功
thsdata 采集完成: {'date': '20260213', 'ztdb_count': 3}
```

```
THS 登录成功
bidding 采集完成: {'date': '20260213', 'jjztdt': {'zts': 35, 'ztfd': 12.5, 'dts': 2, 'dtfd': 1.2}, 'jjbvol_count': 5}
```

---

## 四、一键执行（可选）

可以将三条命令合并为一行顺序执行：

```powershell
python -m app.collectors.stat && python -m app.collectors.thsdata && python -m app.collectors.bidding
```

指定日期版本：

```powershell
python -m app.collectors.stat 2026-02-13 && python -m app.collectors.thsdata 2026-02-13 && python -m app.collectors.bidding 2026-02-13
```

---

## 五、常见问题

### Q: 提示 "iFinDPy not available, skipping THS login"
**原因**: iFinDPy 未正确注册到 Python。
**解决**: 以管理员身份运行：
```powershell
cd D:\THSDataInterface_Windows\bin
python x64\installiFinDPy.py
```

### Q: 提示 "THS 登录失败" + 错误码
**原因**: iFinDPy 账号认证失败或网络不通。
**解决**: 检查网络连接，确认 iFinDPy 账号有效。

### Q: thsdata/bidding 提示 "无昨日涨停数据"
**原因**: 未先运行 stat 采集昨日数据。
**解决**: 先运行 `python -m app.collectors.stat <昨日交易日>` 补采昨日数据。

### Q: 数据库连接失败
**原因**: `.env` 文件缺失或配置错误。
**解决**: 检查项目根目录下 `.env` 文件是否存在，内容应为：
```
DATABASE_URL=mysql+pymysql://root:yz188188@34.123.208.235:3306/catclawboard
```

### Q: 非交易日运行脚本会怎样？
脚本会自动回退到最近的交易日进行采集，不会报错。

---

## 六、采集时间建议

| 脚本 | 建议运行时间 | 说明 |
|------|-------------|------|
| stat | 15:05 以后 | 收盘后涨停数据稳定 |
| thsdata | stat 之后 | 依赖 stat 数据 |
| bidding | 9:25 竞价结束后 | 采集竞价阶段数据；也可收盘后运行 |

---

## 七、自动调度器（推荐）

项目内置了自动调度器 `scheduler.py`，启动后作为常驻进程运行，自动在交易日的指定时间执行三个采集任务，**无需手动操作**。

### 采集时间表

| 时间 | 任务 | 说明 |
|------|------|------|
| 9:26 | bidding | 竞价结束后立即采集，执行一次 |
| 9:30 – 9:40 | thsdata | 开盘初期连续循环采集涨停反包数据 |
| 15:05 | stat | 收盘后采集涨停统计，执行一次 |

> 非交易日自动跳过，无需人工干预。

### 启动命令

```powershell
cd C:\Users\mac\Desktop\Coiding\catclawboard-server

# 正常调度模式（常驻进程，按时间表自动执行）
python -m app.collectors.scheduler

# 立即执行模式（测试/手动补采）
python -m app.collectors.scheduler --now
```

### 立即执行模式（--now）

`--now` 模式跳过时间等待和交易日检查，立即依次执行 bidding → thsdata → stat，执行完即退出。适用于：

- 快速验证采集流程是否正常
- 手动补采当天数据
- 测试环境调试

自动推算最近交易日，非交易日运行会回退到上一个交易日。

### 日志输出示例

```
[2026-02-13 09:20:00] 调度器启动，登录 THS...
[2026-02-13 09:20:01] 交易日 2026-02-13，等待采集时间...
[2026-02-13 09:26:00] 执行 bidding...
[2026-02-13 09:26:05] bidding 完成: {'date': '20260213', ...}
[2026-02-13 09:30:00] 执行 thsdata...
[2026-02-13 09:30:03] thsdata 完成: {'date': '20260213', 'ztdb_count': 3}
[2026-02-13 15:05:00] 执行 stat...
[2026-02-13 15:05:08] stat 完成: {'date': '20260213', ...}
[2026-02-13 15:05:08] 今日采集全部完成
[2026-02-13 15:05:08] 等待下一个交易日... (18.2 小时后)
```

### 停止方式

在终端按 **Ctrl+C**，调度器会自动登出 THS 后退出。

### 三种运行方式对比

| | 手动执行 | 调度器（正常） | 调度器（--now） |
|---|---------|--------------|----------------|
| 操作方式 | 每天手动输入 3 条命令 | 启动一次，持续运行 | 一条命令，执行完退出 |
| 时间控制 | 需要记住时间点 | 自动按时间表触发 | 立即执行 |
| 非交易日 | 需要自己判断 | 自动跳过 | 回退到最近交易日 |
| 适用场景 | 补采指定日期数据 | 日常生产环境 | 测试验证、手动补采当天 |

> **建议**: 日常使用自动调度器，快速补采用 `--now`，补采历史数据用手动指定日期。
